# 第十章：不可变基础设施：资源调度

本章深入探讨了 Kubernetes 的核心功能之一——调度。调度器负责为新创建的 Pod 在集群中寻找最合适的节点来运行，其背后是一套复杂的资源管理、服务质量保障和优先级决策机制。

## 1. 资源模型

- **资源分类**：调度主要关注物理资源，特别是 CPU 和内存。
  - **可压缩资源 (CPU)**：资源不足时，Pod 的性能会下降（饥饿），但不会被终止。单位为 `Core` 或 `m` (Millicores)。
  - **不可压缩资源 (Memory)**：资源一旦耗尽或超出限制，Pod 会被系统杀死（OOM）。单位为 `Bytes`。
- **资源请求与限制 (`requests` vs `limits`)**：
  - `requests`：Pod 期望获得的资源量，是**调度器进行节点选择的依据**。
  - `limits`：Pod 允许使用的资源上限，是 **cgroups 强制执行的约束**。
  - 这种分离设计旨在提高集群的资源利用率，允许一定程度的资源超卖（Overcommit）。

## 2. 服务质量 (QoS) 与优先级

- **服务质量等级 (QoS Class)**：Kubernetes 根据 `requests` 和 `limits` 的设置，自动为 Pod 划分 QoS 等级，这是节点资源紧张时决定驱逐顺序的主要依据。
  - **`Guaranteed`**：最高等级。Pod 中所有容器都必须同时设置 `requests` 和 `limits`，且两者的值完全相等。这类 Pod 最后被驱逐。
  - **`Burstable`**：中等等级。Pod 中至少有一个容器的 `requests` 值小于 `limits` 值。
  - **`BestEffort`**：最低等级。Pod 中所有容器都没有设置 `requests` 和 `limits`。这类 Pod 最先被驱逐。

- **优先级 (Priority) 与抢占 (Preemption)**：
  - **`PriorityClass`**：一种集群级别的资源，用于显式定义 Pod 的重要性。
  - **调度影响**：高优先级的 Pod 会被优先调度。
  - **抢占机制**：当一个高优先级的 Pod 因资源不足而无法调度时，调度器会**驱逐**（杀死）一个或多个运行在节点上的、优先级更低的 Pod，为高优先级 Pod 腾出空间。

## 3. 驱逐机制 (Eviction)

- **触发**：由每个节点上的 `kubelet` 进程执行。当节点上的不可压缩资源（如内存、磁盘空间）低于预设的阈值时，驱逐机制被激活。
- **软驱逐 (Soft Eviction)**：当资源使用达到一个较低的“软”阈值时，会启动一个宽限期（Grace Period）。如果资源在宽限期内没有恢复，`kubelet` 会优雅地终止 Pod。
- **硬驱逐 (Hard Eviction)**：当资源使用达到一个更高的“硬”阈值时，`kubelet` 会立即强制杀死 Pod，以保证节点稳定。
- **驱逐后处理**：被驱逐的 Pod 通常由其控制器（如 ReplicaSet）重建。为避免新 Pod 被调度回同一个压力大的节点，Kubernetes 设有相应机制进行规避。

## 4. 默认调度器工作原理

Kubernetes 调度器采用**共享状态的双循环机制**，以实现高效调度。

- **两大循环**：
  - **Informer Loop**：监控 `etcd` 中 Pod 和 Node 等资源的变化，实时更新**调度队列**和**调度缓存**。
  - **Scheduler Loop**：不断从调度队列中取出待调度的 Pod，执行核心调度算法。

- **核心调度算法**：
  1.  **预选阶段 (Predicate / Filtering)**：
      - **目的**：过滤掉不满足 Pod 运行条件的节点。
      - **依据**：完全基于**调度缓存**中的数据，速度快。
      - **过滤策略**：包括资源是否足够（CPU、内存）、端口是否冲突、Volume 是否匹配、节点亲和性/反亲和性、污点与容忍度等。
  2.  **优选阶段 (Priority / Scoring)**：
      - **目的**：从通过预选的节点中，选出“最合适”的一个。
      - **方式**：对每个候选节点进行打分（0-10分）。
      - **评分规则**：
          - `LeastRequestedPriority`：倾向于选择空闲资源（CPU和内存）最多的节点。
          - `BalancedResourceAllocation`：倾向于选择资源使用率更均衡的节点。
          - 其他规则如 `ImageLocalityPriority`（优先选择已存在所需镜像的节点）等。
  3.  **绑定阶段 (Binding)**：
      - 选出得分最高的节点后，调度器并不会等待 Pod 创建完成。
      - 它采用**乐观绑定**策略：先在调度缓存中更新 Pod 的 `nodeName` 字段，然后异步地更新 `etcd`。
      - 目标节点上的 `kubelet` 监听到 `nodeName` 变化后，会接手后续的 Pod 创建流程。
