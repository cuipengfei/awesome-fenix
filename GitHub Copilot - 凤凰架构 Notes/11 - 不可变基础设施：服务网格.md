# 第十一章：不可变基础设施：服务网格

本章系统性地介绍了服务网格（Service Mesh）的理念、演进、核心技术原理及其生态系统。服务网格是专用于处理服务间通信的基础设施层，它弥补了容器编排系统在微服务治理上的不足，将通信控制的粒度从容器级别细化到了单个服务。

## 1. 透明通信的演进之路

服务网格的出现并非一蹴而就，而是分布式系统通信方式演进的必然结果：

1.  **阶段一：业务与通信逻辑耦合**：开发者在业务代码中直接处理重试、熔断等分布式通信问题。专业性要求高，代码复用性差。
2.  **阶段二：抽取公共组件库**：将通信逻辑封装到公共库中（如 Spring Cloud、Finagle），实现了代码复用，但与特定编程语言和框架绑定，学习成本高。
3.  **阶段三：独立网络代理**：将通信能力移至进程外的独立代理，应用需主动访问代理。此模式演化出了微服务网关和边车代理两条路线。
4.  **阶段四：边车代理（Sidecar Proxy）**：将代理以边车容器的形式注入到应用 Pod 中，通过流量劫持，对应用透明且强制地接管所有进出流量。
5.  **阶段五：服务网格**：将所有边车代理统一管理起来，形成**数据平面**和**控制平面**，实现了通用、透明、可控的可靠通信。

## 2. 数据平面 (Data Plane)

数据平面由一系列的边车代理（如 Envoy）组成，负责直接处理和转发服务间的通信流量。

- **代理注入**：
  - **手动注入**：通过 `istioctl kube-inject` 等工具修改 Pod 的 YAML 文件，手动添加边车容器。
  - **自动注入**：利用 Kubernetes 的**动态准入控制**（`MutatingAdmissionWebhook`），在创建 Pod 时自动注入边车容器。这是 Istio 的推荐方式。
- **流量劫持**：
  - **iptables**：最经典的方式。通过在 Pod 的网络命名空间中设置 `iptables` 规则，将所有进出流量重定向到边车代理的特定端口。此方式通用但有一定性能损耗。
  - **eBPF**：一种更高效的内核技术，可在 Socket 层面直接转发流量，减少网络协议栈的穿越，性能更优。
  - **CNI 插件**：由服务网格提供自己的 CNI 网络插件，从网络底层接管流量，完全绕开 `iptables`。
- **可靠通信 (xDS 协议)**：
  - 数据平面的行为由控制平面通过 **xDS API** 动态配置。xDS (Discovery Service) 是一系列发现服务的统称。
  - **核心资源**：`Listener` (监听器)、`Route` (路由)、`Cluster` (上游服务集群)、`Endpoint` (集群实例)。
  - Envoy 等代理通过订阅 xDS 服务，动态获取路由规则、服务发现信息、负载均衡策略等，从而实现智能的流量治理。

## 3. 控制平面 (Control Plane)

控制平面（如 Istio）是服务网格的大脑，它不直接参与服务间的数据转发，而是负责管理和配置所有的边车代理。

- **Istio 架构演进**：从 1.5 版本开始，Istio 将原先的多个微服务组件（Pilot, Galley, Citadel, Mixer）合并为一个单体的 `istiod` 进程，大大简化了部署和维护。
- **核心功能**：
  - **策略分发**：作为 xDS 服务端，向数据平面下发所有流量治理和安全策略。
  - **流量控制**：通过 `VirtualService`、`DestinationRule` 等 CRD 资源，实现精细的请求路由（如金丝雀发布）、流量治理（熔断、超时、重试）和故障注入等高级功能。
  - **通信安全**：自动实现服务间的 mTLS 加密通信，管理证书、认证和授权策略。
  - **可观测性**：自动为所有网格内的流量生成详细的**日志**、**分布式追踪**和**监控指标**，无需修改应用代码。

## 4. 服务网格生态

服务网格领域仍在快速发展，并逐渐形成行业标准。

- **标准化**：
  - **SMI (Service Mesh Interface)**：由微软等厂商推动的、面向**控制平面**的标准化 API，旨在让上层应用能在不同服务网格产品间移植。
  - **UDPA (Universal Data Plane API)**：基于 Envoy xDS 演进而来的、面向**数据平面**的标准化 API，旨在统一代理与控制平面的交互方式。
- **主流产品**：
  - **数据平面**：`Envoy` (市场领导者), `Linkerd2-proxy` (Rust 开发，性能优异), `MOSN` (蚂蚁金服开源) 等。
  - **控制平面**：`Istio` (功能最强，生态最广), `Linkerd 2` (以轻量、简单著称), `Consul Connect` (集成 HashiCorp 生态), `Open Service Mesh (OSM)` (微软开源，SMI 的参考实现) 等。

服务网格通过将网络通信的复杂性从应用中剥离到基础设施层，极大地降低了微服务开发的门槛，是云原生技术栈中至关重要的一环。
